<%# app/views/risk_assistants/summary.html.erb %>


<div class="chat-container container-fluid py-3 bg-light">
  <div class="chat-layout">
    
    <%# Sidebar (Responsive) %>
    <aside class="assistant-sidebar d-none d-lg-flex">
      <%= render partial: "sidebar_nav",
                 locals: { risk_assistant: @risk_assistant, sections: @sections, progress_by_section: @progress_by_section, overall_pct: @overall_pct } %>
    </aside>

    <div class="offcanvas offcanvas-start d-lg-none" id="sidebarCanvas">
      <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title">Panel del asistente</h5>
        <button class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body p-0">
        <%= render partial: "sidebar_nav",
                   locals: { risk_assistant: @risk_assistant, sections: @sections, progress_by_section: @progress_by_section, overall_pct: @overall_pct } %>
      </div>
    </div>

    <main class="chat-page chat-main flex-grow-1" style="overflow-y: auto;">
      <div class="container py-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="h3 fw-bold text-dark mb-1"><%= @risk_assistant.name %></h1>
            <p class="text-muted mb-0">Resumen de datos recopilados</p>
          </div>
          <div>
            <%= link_to "Descargar Informe", report_risk_assistant_path(@risk_assistant), class: "btn btn-outline-primary btn-sm" %>
          </div>
        </div>

        <% RiskFieldSet.all.each do |section_id, section_hash| %>
          <% section_label = section_hash[:title] %>
          <% fields = section_hash[:fields] %>
          <% 
             # Check if section has any data to decide whether to show "Empty" state or hide
             # (Optional optimization: hide sections with NO data? User probably wants to see them anyway)
          %>

          <div class="card border-0 shadow-sm mb-4 rounded-3 overflow-hidden">
            <div class="card-header bg-white border-bottom py-3">
              <h5 class="mb-0 fw-bold text-primary"><%= section_label %></h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                  <thead class="bg-light text-uppercase text-muted small">
                    <tr>
                      <th style="width: 40%;" class="ps-4 py-3">Campo</th>
                      <th style="width: 60%;" class="py-3">Valor</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% fields.each do |f| %>
                      <% 
                         key = f[:id].to_s 
                         # Retrieve value from JSONB data
                         value = fetch_data(@risk_assistant.data, key)
                      %>

                      <%# Headers for Groups/Subsections %>
                      <% if ["subsection", "group"].include?(f[:type].to_s) %>
                        <tr class="table-light">
                          <td colspan="2" class="fw-bold text-secondary ps-4 py-3">
                            <i class="bi bi-chevron-right me-1 small"></i><%= f[:label] %>
                          </td>
                        </tr>
                        <% next %>
                      <% end %>

                      <%# Skip empty internal IDs if desired, but show pending fields %>
                      <% 
                         display_value = value.presence || content_tag(:span, "—", class: "text-muted opacity-50")
                         row_class = value.present? ? "" : "text-muted"
                      %>

                      <tr class="<%= row_class %>">
                        <td class="ps-4 fw-medium text-secondary"><%= f[:label] %></td>
                        <td>
                          <% case f[:type].to_s %>
                          <% when "boolean" %>
                            <% if [true, "true", "Sí", "sí"].include?(value) %>
                              <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle px-3">Sí</span>
                            <% elsif [false, "false", "No", "no"].include?(value) %>
                               <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle px-3">No</span>
                            <% else %>
                              <%= display_value %>
                            <% end %>

                          <% when "select" %>
                            <% if value.present? %>
                              <span class="badge bg-secondary-subtle text-dark border border-secondary-subtle fw-normal px-2"><%= value %></span>
                            <% else %>
                              <%= display_value %>
                            <% end %>

                          <% when "number", "currency" %>
                            <span class="font-monospace"><%= value.present? ? number_with_delimiter(value.to_f, delimiter: ".") : display_value %></span>

                          <% when "file", "file_multiple" %>
                            <%# File logic remains querying Messages or Attachments since files aren't in JSONB directly usually (unless stored as URL) %>
                            <%# We fallback to message lookup for files as their IDs are complex %>
                            <% msg = @risk_assistant.messages.find_by(key: key) %>
                            <% if msg&.files&.attached? %>
                              <div class="d-flex flex-wrap gap-2">
                                <% msg.files.each do |file| %>
                                  <%= link_to rails_blob_path(file, disposition: "attachment"), target: "_blank", class: "btn btn-sm btn-outline-secondary d-inline-flex align-items-center" do %>
                                    <i class="bi bi-file-earmark-text me-2"></i><%= file.filename %>
                                  <% end %>
                                <% end %>
                              </div>
                            <% else %>
                              <%= display_value %>
                            <% end %>

                          <% when "boolean_group" %>
                            <% values = value.is_a?(Array) ? value : value.to_s.split(/\s*,\s*/) %>
                            <% if values.any? %>
                              <div class="d-flex flex-wrap gap-1">
                                <% values.each do |val| %>
                                  <span class="badge bg-info-subtle text-info-emphasis border border-info-subtle"><%= val %></span>
                                <% end %>
                              </div>
                            <% else %>
                              <%= display_value %>
                            <% end %>

                           <% when "object" %>
                            <%# Handle nested object display simply %>
                             <%= display_value %>

                          <% when "array_of_objects" %>
                            <% if value.is_a?(Array) && value.any? %>
                              <% 
                                 # Get schema for table columns
                                 array_id = f[:id]
                                 subfields = RiskFieldSet.flat_fields
                                                .select { |sf| sf[:parent] == array_id }
                                                .reject { |sf| sf[:type].to_s == "subsection" }
                              %>
                              <div class="card card-body bg-light border-0 p-2 mt-1">
                                <table class="table table-sm table-bordered bg-white mb-0 small">
                                  <thead>
                                    <tr>
                                      <th>#</th>
                                      <% subfields.each do |sf| %>
                                        <th><%= sf[:label] %></th>
                                      <% end %>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% value.each_with_index do |row_data, idx| %>
                                      <tr>
                                        <td class="text-muted"><%= idx + 1 %></td>
                                        <% subfields.each do |sf| %>
                                          <% 
                                             col_key = sf[:id].split(".").last 
                                             cell_val = row_data[col_key] rescue nil 
                                          %>
                                          <td><%= cell_val.presence || "-" %></td>
                                        <% end %>
                                      </tr>
                                    <% end %>
                                  </tbody>
                                </table>
                              </div>
                            <% else %>
                              <%= display_value %>
                            <% end %>

                          <% else %>
                            <%= display_value %>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>

      </div>
    </main>
  </div>
</div>
