<div class="container py-4">
  <%= render 'shared/branding' %>

  <h1 class="h3 mb-4">Panel</h1>

  <% if notice %>
    <div class="alert alert-success"><%= notice %></div>
  <% end %>
  <% if alert %>
    <div class="alert alert-danger"><%= alert %></div>
  <% end %>

  <div class="row g-2 mb-4">
    <% if current_user.admin? %>
      <div class="col-md-4 col-lg-2">
        <%= link_to 'Tokens de invitacion', user_clients_path(current_user), class: 'btn btn-primary w-100' %>
      </div>
    <% end %>
    <div class="col-md-4 col-lg-2">
      <%= link_to 'Tomas de datos', data_collections_path, class: 'btn btn-primary w-100' %>
    </div>
    <div class="col-md-4 col-lg-2">
      <%= link_to 'Documentos', data_collections_path(anchor: 'documentos'), class: 'btn btn-primary w-100' %>
    </div>
    <div class="col-md-4 col-lg-2">
      <%= link_to 'Resmenes', data_collections_path(anchor: 'resumenes'), class: 'btn btn-primary w-100' %>
    </div>
    <% unless current_user.guest? %>
      <div class="col-md-4 col-lg-2">
        <%= link_to 'Comparativa de polizas', policy_analyses_path, class: 'btn btn-primary w-100' %>
      </div>
    <% end %>
    <div class="col-md-4 col-lg-2">
      <%= link_to 'Toma de datos con asistente', risk_assistants_path, class: 'btn btn-primary w-100' %>
    </div>
  </div>

  <section class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h4 mb-0">Risk assistants</h2>
      <% if current_user.can_create_risk_assistant? %>
        <%= link_to 'Nuevo', new_risk_assistant_path, class: 'btn btn-success btn-sm' %>
      <% else %>
        <button class="btn btn-secondary btn-sm" disabled>Maximo <%= User::MAX_GUEST_RISK_ASSISTANTS %></button>
      <% end %>
    </div>

    <% if @risk_assistants.present? %>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Nombre</th>
              <% if current_user.admin? %>
                <th>Usuario</th>
              <% end %>
              <th>Actualizado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @risk_assistants.each do |risk_assistant| %>
              <tr>
                <td><%= risk_assistant.name.presence || "Toma ##{risk_assistant.id}" %></td>
                <% if current_user.admin? %>
                  <td><%= risk_assistant.user&.email || 'Sin asignar' %></td>
                <% end %>
                <td><%= l risk_assistant.updated_at, format: :short %></td>
                <td class="text-end d-flex gap-2 justify-content-end flex-wrap">
                  <%= link_to 'Conversacion', risk_assistant_path(risk_assistant), class: 'btn btn-outline-primary btn-sm' %>
                  <%= link_to 'Summary', summary_risk_assistant_path(risk_assistant), class: 'btn btn-outline-secondary btn-sm' %>
                  <%= link_to 'Documentos', risk_assistant_documents_path(risk_assistant), class: 'btn btn-outline-secondary btn-sm' %>
                  <%= link_to 'Tabla de datos', risk_assistant_resume_path(risk_assistant), class: 'btn btn-outline-secondary btn-sm' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">Aun no hay tomas de datos.</p>
    <% end %>
  </section>

  <% if current_user.admin? %>
    <section>
      <h2 class="h4 mb-2">Invitaciones pendientes</h2>
      <% if @client_invitations.any? %>
        <ul class="list-group">
          <% @client_invitations.each do |invitation| %>
            <li class="list-group-item d-flex justify-content-between">
              <span><%= invitation.email.presence || 'Sin email' %></span>
              <code><%= invitation.token %></code>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted">No hay invitaciones pendientes.</p>
      <% end %>
    </section>
  <% end %>
</div>
